<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatórios Armazenados</title>
  <link href="styles.css" rel="stylesheet">
  <style>
    .logo { width: 60px; height: auto; }
    .relatorio-data {
      margin-left: 20px;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
      display: inline-block;
      margin: 4px 0;
    }
    .relatorio-data:hover { color: darkblue; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  </style>
</head>
<body class="detalhes-page">
  <header>
    <div class="header-container">
      <h1>Relatórios Armazenados</h1>
      <div class="header-buttons">
        <button onclick="window.location.href='detalhes.html'">Voltar</button>
        <button id="themeToggleButton">Tema</button>
      </div>
    </div>
  </header>

  <main style="padding: 20px;">
    <section>
      <h2>Relatórios Gerados</h2>
      <button id="excluirTodosButton">Excluir Todos</button>
      <div id="listaRelatorios"></div>
    </section>

    <section style="margin-top: 30px;">
      <h2>Materiais Solicitados</h2>
      <table>
        <thead>
          <tr>
            <th>LOCAL</th><th>ITEM</th><th>QTD</th><th>DESTINO</th>
            <th>DATA</th><th>HORA</th><th>TEMPO</th><th>REPORTADO</th>
          </tr>
        </thead>
        <tbody id="solicitadosBody"></tbody>
      </table>
    </section>

    <section style="margin-top: 30px;">
      <h2>Materiais Recebidos</h2>
      <table>
        <thead>
          <tr>
            <th>LOCAL</th><th>ITEM</th><th>QTD</th><th>DESTINO</th>
            <th>DATA</th><th>HORA</th><th>RECEBIDO</th>
            <th>TEMPO</th><th>GUARDADO</th> <!-- Exibe tempo -->
          </tr>
        </thead>
        <tbody id="recebidosBody"></tbody>
      </table>
    </section>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tema
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
    }
    const themeBtn = document.getElementById('themeToggleButton');
    themeBtn.addEventListener('click', () => {
      if (document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
      }
    });

    // Carrega relatorios
    const stored = localStorage.getItem('relatoriosMes');
    if (!stored) {
      document.getElementById('listaRelatorios').innerHTML = "<p>Nenhum relatório encontrado.</p>";
      return;
    }
    const relatoriosMes = JSON.parse(stored);
    console.log('[DATArelatorio] relatoriosMes:', relatoriosMes);

    let html = '';
    for (let mes in relatoriosMes) {
      html += `<h3>📁 ${mes}</h3>`;
      const datasObj = relatoriosMes[mes];
      for (let dataCurta in datasObj) {
        html += `
          <div class="relatorio-data" data-mes="${mes}" data-data="${dataCurta}">
            📄 ${dataCurta}
          </div>
        `;
      }
    }
    document.getElementById('listaRelatorios').innerHTML = html;

    // Expansão
    const dataEls = document.querySelectorAll('.relatorio-data');
    dataEls.forEach(el => {
      el.addEventListener('click', () => {
        const mes = el.getAttribute('data-mes');
        const dataC = el.getAttribute('data-data');
        const entry = relatoriosMes[mes][dataC];
        if (!entry) return;

        const { solicitados, recebidos } = entry;
        console.log(`[DATArelatorio] clique: mes=${mes}, data=${dataC}`, entry);

        // Solicited
        const solBody = document.getElementById('solicitadosBody');
        solBody.innerHTML = '';
        if (solicitados && solicitados.length > 0) {
          solicitados.forEach((item, i) => {
            console.log(`[DATArelatorio] solicitados[${i}]:`, item);
            solBody.insertAdjacentHTML('beforeend', `
              <tr>
                <td>${item.local}</td>
                <td>${item.item}</td>
                <td>${item.qtd}</td>
                <td>${item.destino}</td>
                <td>${item.data}</td>
                <td>${item.hora}</td>
                <td>${item.tempo}</td>
                <td>${item.reportado}</td>
              </tr>
            `);
          });
        }

        // Received
        const recBody = document.getElementById('recebidosBody');
        recBody.innerHTML = '';
        if (recebidos && recebidos.length > 0) {
          recebidos.forEach((item, i) => {
            console.log(`[DATArelatorio] recebidos[${i}]:`, item);
            recBody.insertAdjacentHTML('beforeend', `
              <tr>
                <td>${item.local}</td>
                <td>${item.item}</td>
                <td>${item.qtd}</td>
                <td>${item.destino}</td>
                <td>${item.data}</td>
                <td>${item.hora}</td>
                <td>${item.recebido}</td>
                <td>${item.tempo}</td>   <!-- Exibe tempo -->
                <td>${item.guardado}</td>
              </tr>
            `);
          });
        }
      });
    });

    // Excluir todos
    const excluirBtn = document.getElementById('excluirTodosButton');
    excluirBtn.addEventListener('click', () => {
      if (confirm('Deseja realmente excluir TODOS os relatórios?')) {
        localStorage.removeItem('relatoriosMes');
        location.reload();
      }
    });
  });
  </script>
</body>
</html>
